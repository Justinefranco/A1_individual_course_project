---
title: "A1_Individual Project"
author: "Justine Franco"
date: "2023-07-09"
output: html_document
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Weekly sales forecasting starter:
#  Install forecast-package first.
library(tidyverse)
library(forecast)
library(shiny)

# historical records from multiple stores
fsales <- "https://raw.githubusercontent.com/multidis/hult-inter-bus-reports-r/main/forecasting/sales_weekly.csv"
sales <- read_csv(fsales)
sales

# latest (current) week
nweek_now <- max(sales$Week)

# calculate the range of stores
store_range <- range(sales$Store)
store_min <- store_range[1]
store_max <- store_range[2]

# calculate the range of weeks
week_range <- range(sales$Week)
week_min <- week_range[1]
week_max <- week_range[2]

# add year, month, and quarter to the sales table
sales$Year = floor((sales$Week - 1) / 52) + 1

# Calculate Month
sales$Month = ceiling(((sales$Week - 1) %% 52) / 4.33) + 1

# Calculate Quarter
sales$Quarter = ceiling(sales$Month / 3)

# find max year
year_max <- max(sales$Year)

# find the max month of the current year
max_month_currYear <- sales %>%
  filter(Year == year_max) %>%
  pull(Month) %>%
  max()

```


## Provide a current week performance indicator in the UI showing current week's actual sales vs. forecast for the current week computed at the end of the last week.



```{r, echo=FALSE}
inputPanel(selectInput(
  "storenum",
  label = "Select store: ",
  choices = 1:max(sales$Store),
  selected = 1
),)

# latest (current) week
nweek_now <- max(sales$Week)

renderDataTable({
  # check forecast accuracy for the most recent quarter
  sales_hist <- sales %>%
    filter(Store == input$storenum) %>%
    subset(Week < nweek_now)
  sales_last <- sales %>%
    filter(Store == input$storenum) %>%
    subset(Week >= nweek_now)
  
  # time series with annual periodicity to account seasonality
  sales_hist_ts <- ts(sales_hist$Weekly_Sales, frequency = 52)
  # autoplot(sales_hist_ts)
  
  # ARIMA: Auto-Regressive Integrated Moving Average
  # methodological details:
  #  https://otexts.com/fpp3/arima.html
  arima_model <- auto.arima(sales_hist_ts, seasonal.test = "seas")
  
  # forecast horizon to match most recent quarter
  arima_pred <- forecast(arima_model, h = 1)
  
  # note: confidence intervals (lower, upper) are available as well
  sales_pred_eval <-
    data.frame(
      predicted = as.numeric(arima_pred$mean),
      actual = sales_last$Weekly_Sales,
      Week = sales_last$Week
    )
  sales_pred_eval
  
})

```


## Generate sales forecast for a given week (within the next three months) selected in the UI 

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(shiny)
library(forecast)

# Create the Shiny app
ui <- fluidPage(
  titlePanel("Forecast"),
    sidebarPanel(
      sliderInput("horizon", "Forecast Horizon (weeks)", min = 1, max = 12, value = 12),
      selectInput("store_3", "Select Store", choices = unique(sales$Store), selected = 3)
    ),
    mainPanel(
      plotlyOutput("salesChart"),
      tableOutput("salesTable")
    )
  )

server <- function(input, output) {
  # Generate the sales forecast chart
  output$salesChart <- renderPlotly({
    # Filter the sales data for the selected store
    sales_store <- sales %>% filter(Store == input$store_3)
    
    # Perform forecasting for the selected store
    sales_ts <- ts(sales_store$Weekly_Sales, frequency = 52)
    
    # ARIMA: Auto-Regressive Integrated Moving Average
    # methodological details:
    #  https://otexts.com/fpp3/arima.html
    arima_model <- auto.arima(sales_ts, seasonal.test = "seas")
    forecasted_sales <- forecast(arima_model, h = input$horizon)
    
    # Create the plotly object
    plot_ly() %>%
      add_lines(x = sales_store$Week, y = sales_store$Weekly_Sales, name = "Actual Sales", type = "scatter", mode = "lines", line = list(color = "green")) %>%
      add_lines(x = (max(sales_store$Week) + 1):(max(sales_store$Week) + input$horizon), y = forecasted_sales$mean, name = "Forecast", type = "scatter", mode = "lines", line = list(color = "red")) %>%
      layout(
        title = "Sales Forecast",
        xaxis = list(title = "Weeks"),
        yaxis = list(title = "Sales")
      )
  })
  
  # Generate the forecasted sales table
  output$salesTable <- renderTable({
    # Filter the sales data for the selected store
    sales_store <- sales %>% filter(Store == input$store_3)
    
    # Perform forecasting for the selected store
    sales_ts <- ts(sales_store$Weekly_Sales, frequency = 52)
    arima_model <- auto.arima(sales_ts, seasonal.test = "seas")
    forecasted_sales <- forecast(arima_model, h = input$horizon)
    
    # Create a data frame with the forecasted sales
    forecast_table <- data.frame(Week = (max(sales_store$Week) + 1):(max(sales_store$Week) + input$horizon),
                                 Forecast = forecasted_sales$mean)
    
    forecast_table
  })
}

# Run the app
shinyApp(ui = ui, server = server)
```
